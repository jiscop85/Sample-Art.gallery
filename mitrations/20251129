-- ========================================
-- 1. User Profiles Table
-- ========================================
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT,
  phone TEXT,
  address TEXT,
  avatar_url TEXT,
  wallet_balance DECIMAL(10, 2) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON public.profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON public.profiles FOR UPDATE
  USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile"
  ON public.profiles FOR INSERT
  WITH CHECK (auth.uid() = id);

-- ========================================
-- 2. User Roles Table (for admin access)
-- ========================================
CREATE TYPE public.app_role AS ENUM ('admin', 'user');

CREATE TABLE public.user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  role app_role NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  UNIQUE(user_id, role)
);

ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own roles"
  ON public.user_roles FOR SELECT
  USING (auth.uid() = user_id);

-- Security definer function to check roles
CREATE OR REPLACE FUNCTION public.has_role(_user_id UUID, _role app_role)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = _user_id AND role = _role
  )
$$;

-- ========================================
-- 3. Painting Styles Table
-- ========================================
CREATE TABLE public.painting_styles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name_fa TEXT NOT NULL,
  name_en TEXT NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.painting_styles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active styles"
  ON public.painting_styles FOR SELECT
  USING (is_active = true);

-- Insert default styles
INSERT INTO public.painting_styles (name_fa, name_en, description) VALUES
  ('رئالیسم', 'Realism', 'نقاشی با جزئیات کامل و دقیق'),
  ('پرتره', 'Portrait', 'چهره‌نگاری حرفه‌ای و هنری'),
  ('آبستره', 'Abstract', 'هنر مدرن و انتزاعی'),
  ('آبرنگ', 'Watercolor', 'نقاشی با رنگ‌های شفاف'),
  ('رنگ روغن', 'Oil Painting', 'تکنیک کلاسیک و ماندگار'),
  ('دیجیتال آرت', 'Digital Art', 'هنر دیجیتال و نوین');
