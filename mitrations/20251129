-- ========================================
-- 1. User Profiles Table
-- ========================================
CREATE TABLE public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  full_name TEXT,
  phone TEXT,
  address TEXT,
  avatar_url TEXT,
  wallet_balance DECIMAL(10, 2) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profile"
  ON public.profiles FOR SELECT
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON public.profiles FOR UPDATE
  USING (auth.uid() = id);

CREATE POLICY "Users can insert own profile"
  ON public.profiles FOR INSERT
  WITH CHECK (auth.uid() = id);

-- ========================================
-- 2. User Roles Table (for admin access)
-- ========================================
CREATE TYPE public.app_role AS ENUM ('admin', 'user');

CREATE TABLE public.user_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  role app_role NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  UNIQUE(user_id, role)
);

ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own roles"
  ON public.user_roles FOR SELECT
  USING (auth.uid() = user_id);

-- Security definer function to check roles
CREATE OR REPLACE FUNCTION public.has_role(_user_id UUID, _role app_role)
RETURNS BOOLEAN
LANGUAGE SQL
STABLE
SECURITY DEFINER
SET search_path = public
AS $$
  SELECT EXISTS (
    SELECT 1
    FROM public.user_roles
    WHERE user_id = _user_id AND role = _role
  )
$$;

-- ========================================
-- 3. Painting Styles Table
-- ========================================
CREATE TABLE public.painting_styles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name_fa TEXT NOT NULL,
  name_en TEXT NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.painting_styles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active styles"
  ON public.painting_styles FOR SELECT
  USING (is_active = true);

-- Insert default styles
INSERT INTO public.painting_styles (name_fa, name_en, description) VALUES
  ('رئالیسم', 'Realism', 'نقاشی با جزئیات کامل و دقیق'),
  ('پرتره', 'Portrait', 'چهره‌نگاری حرفه‌ای و هنری'),
  ('آبستره', 'Abstract', 'هنر مدرن و انتزاعی'),
  ('آبرنگ', 'Watercolor', 'نقاشی با رنگ‌های شفاف'),
  ('رنگ روغن', 'Oil Painting', 'تکنیک کلاسیک و ماندگار'),
  ('دیجیتال آرت', 'Digital Art', 'هنر دیجیتال و نوین');

-- ========================================
-- 4. Artists Table
-- ========================================
CREATE TABLE public.artists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  bio TEXT,
  avatar_url TEXT,
  portfolio_url TEXT,
  rating DECIMAL(3, 2) DEFAULT 0,
  total_orders INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.artists ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active artists"
  ON public.artists FOR SELECT
  USING (is_active = true);

CREATE POLICY "Admins can manage artists"
  ON public.artists FOR ALL
  USING (public.has_role(auth.uid(), 'admin'));

-- ========================================
-- 5. Orders Table
-- ========================================
CREATE TYPE public.order_status AS ENUM ('pending', 'ai_preview', 'confirmed', 'in_progress', 'completed', 'cancelled');
CREATE TYPE public.canvas_size AS ENUM ('30x40', '50x70', '70x100', '100x100', 'custom');
CREATE TYPE public.material_type AS ENUM ('oil', 'watercolor', 'acrylic', 'pencil', 'digital');

CREATE TABLE public.orders (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  style_id UUID REFERENCES public.painting_styles(id) NOT NULL,
  artist_id UUID REFERENCES public.artists(id),
  
  -- Order details
  status order_status DEFAULT 'pending' NOT NULL,
  canvas_size canvas_size NOT NULL,
  material material_type NOT NULL,
  reference_image_url TEXT,
  ai_preview_url TEXT,
  ai_prompt TEXT,
  customer_notes TEXT,
  voice_note_url TEXT,
  
  -- Pricing
  base_price DECIMAL(10, 2) NOT NULL,
  rush_fee DECIMAL(10, 2) DEFAULT 0,
  total_price DECIMAL(10, 2) NOT NULL,
  
  -- Delivery
  is_rush BOOLEAN DEFAULT false,
  estimated_delivery_date DATE,
  actual_delivery_date DATE,
  
  -- Progress tracking
  progress_percentage INTEGER DEFAULT 0,
  progress_images TEXT[],
  
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own orders"
  ON public.orders FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create orders"
  ON public.orders FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Admins can view all orders"
  ON public.orders FOR SELECT
  USING (public.has_role(auth.uid(), 'admin'));

CREATE POLICY "Admins can update orders"
  ON public.orders FOR UPDATE
  USING (public.has_role(auth.uid(), 'admin'));

-- ========================================
-- 6. Classes Table
-- ========================================
CREATE TYPE public.class_type AS ENUM ('in_person', 'online');

CREATE TABLE public.classes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  date DATE NOT NULL,
  time_slot TIME NOT NULL,
  class_type class_type NOT NULL,
  max_capacity INTEGER DEFAULT 12 NOT NULL,
  current_bookings INTEGER DEFAULT 0 NOT NULL,
  price DECIMAL(10, 2) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.classes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anyone can view active classes"
  ON public.classes FOR SELECT
  USING (is_active = true);

CREATE POLICY "Admins can manage classes"
  ON public.classes FOR ALL
  USING (public.has_role(auth.uid(), 'admin'));

-- ========================================
-- 7. Class Bookings Table
-- ========================================
CREATE TABLE public.class_bookings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  class_id UUID REFERENCES public.classes(id) ON DELETE CASCADE NOT NULL,
  payment_status TEXT DEFAULT 'pending' NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL,
  UNIQUE(user_id, class_id)
);

ALTER TABLE public.class_bookings ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own bookings"
  ON public.class_bookings FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can create bookings"
  ON public.class_bookings FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Admins can view all bookings"
  ON public.class_bookings FOR SELECT
  USING (public.has_role(auth.uid(), 'admin'));

-- ========================================
-- 8. Wallet Transactions Table
-- ========================================
CREATE TYPE public.transaction_type AS ENUM ('deposit', 'withdrawal', 'order_payment', 'class_payment', 'refund');

CREATE TABLE public.wallet_transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  amount DECIMAL(10, 2) NOT NULL,
  type transaction_type NOT NULL,
  description TEXT,
  order_id UUID REFERENCES public.orders(id),
  created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

ALTER TABLE public.wallet_transactions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own transactions"
  ON public.wallet_transactions FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Admins can view all transactions"
  ON public.wallet_transactions FOR SELECT
  USING (public.has_role(auth.uid(), 'admin'));
